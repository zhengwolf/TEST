#ifndef __TDC_H
#define __TDC_H

#include <stdbool.h>

#include "stm32f4xx_hal.h"

/* write config registers opcode */
#define GP21_WRITE_REG0_REGISTER            (0x80)
#define GP21_WRITE_REG1_REGISTER            (0x81)
#define GP21_WRITE_REG2_REGISTER            (0x82)
#define GP21_WRITE_REG3_REGISTER            (0x83)
#define GP21_WRITE_REG4_REGISTER            (0x84)
#define GP21_WRITE_REG5_REGISTER            (0x85)
#define GP21_WRITE_REG6_REGISTER            (0x86)
/* read read registers opcode */
#define GP21_READ_RES0_REGISTER             (0xB0)
#define GP21_READ_RES1_REGISTER             (0xB1)
#define GP21_READ_RES2_REGISTER             (0xB2)
#define GP21_READ_RES3_REGISTER             (0xB3)
#define GP21_READ_STAT_REGISTER             (0xB4)
#define GP21_READ_REG1_REGISTER             (0xB5)
/* others opcode */
#define GP21_READ_ID                        (0xB7)
#define GP21_WRITE_CFG_TO_EEPROM            (0xC0)
#define GP21_WRITE_EEPROM_TO_CFG            (0xF0)
#define GP21_COMPARE_EEPROM_CFG             (0xC6)
#define GP21_INITIATE_TDC                   (0x70)
#define GP21_POWER_ON_RESET                 (0x50)
#define GP21_START_TOF                      (0x01)
#define GP21_START_TEMP                     (0x02)
#define GP21_START_CAL_RESONATOR            (0x03)
#define GP21_START_CAL_TDC                  (0x04)
#define GP21_START_TOF_RESTART              (0x05)
#define GP21_START_TEMP_RESTART             (0x06)
/* interrupt flag */
#define GP21_INT_TIMEOUT_BIT                (31)
#define GP21_INT_TIMEOUT_ENABLE             (1<<GP21_INT_TIMEOUT_BIT)
#define GP21_INT_TIMEOUT_DISABLE            (0<<GP21_INT_TIMEOUT_BIT)
#define GP21_INT_ENDHITS_BIT                (30)
#define GP21_INT_ENDHITS_ENABLE             (1<<GP21_INT_ENDHITS_BIT)
#define GP21_INT_ENDHITS_DISABLE            (0<<GP21_INT_ENDHITS_BIT)
#define GP21_INT_ALUOVER_BIT                (29)
#define GP21_INT_ALUOVER_ENABLE             (1<<GP21_INT_ALUOVER_BIT)
#define GP21_INT_ALUOVER_DISABLE            (0<<GP21_INT_ALUOVER_BIT)
#define GP21_INT_EEPROM_BIT                 (21)
#define GP21_INT_EEPROM_ENABLE              (1<<GP21_INT_EEPROM_BIT)
#define GP21_INT_EEPROM_DISABLE             (0<<GP21_INT_EEPROM_BIT)
/* error masks */
#define GP21_ERR_MASK_TDC_TIMEOUT           (0x0200)
#define GP21_ERR_MASK_PRE_CNT_TIMEOUT       (0x0400)
#define GP21_ERR_MASK_TEMP_SENSER_OPEN      (0x0800)
#define GP21_ERR_MASK_TEMP_SENSER_SHORT     (0x1000)
#define GP21_ERR_MASK_EEPROM_ERR            (0x2000)
#define GP21_ERR_MASK_EEPROM_ERRS           (0x4000)
#define GP21_ERR_ERRORS                     (GP21_ERR_MASK_EEPROM_ERRS       |\
        GP21_ERR_MASK_EEPROM_ERR        |\
        GP21_ERR_MASK_TEMP_SENSER_SHORT |\
        GP21_ERR_MASK_TEMP_SENSER_OPEN  |\
        GP21_ERR_MASK_PRE_CNT_TIMEOUT   |\
        GP21_ERR_MASK_TDC_TIMEOUT)

/*
    config register0 :
    ANZ_FIRE             DIV_FIRE          ANZ_PER_CALRES
    DIV_CLKHS            START_CLKHS       ANZ_PORT
    TCYCLE               ANZ_FAKE          SEL_ECLK_TMP
    CALIBRATE            NO_CAL_AUTO       MESSB2
    NEG_STOP/NEGSTART    ID0
*/
#define GP21_CONFIG_VALUE_ANZ_FIRE_L(v)     (((v)&0x0FU)<<28)
#define GP21_CONFIG_VALUE_DIV_FIRE(v)       (((v)&0x0FU)<<24)
#define GP21_CONFIG_VALUE_ANZ_PER_CALRES_MASK (3U<<22)
#define GP21_CONFIG_VALUE_ANZ_PER_CALRES_2  (0U<<22)
#define GP21_CONFIG_VALUE_ANZ_PER_CALRES_4  (1U<<22)
#define GP21_CONFIG_VALUE_ANZ_PER_CALRES_8  (2U<<22)
#define GP21_CONFIG_VALUE_ANZ_PER_CALRES_16 (3U<<22)
#define GP21_CONFIG_VALUE_DIV_CLKHS_MASK    (3U<<20)
#define GP21_CONFIG_VALUE_DIV_CLKHS_1       (0U<<20)
#define GP21_CONFIG_VALUE_DIV_CLKHS_2       (1U<<20)
#define GP21_CONFIG_VALUE_DIV_CLKHS_4       (2U<<20)
#define GP21_CONFIG_VALUE_START_CLKHS_L(v)  (((v)&0x03U)<<18)
#define GP21_CONFIG_VALUE_START_CLKHS_OFF   (0U)
#define GP21_CONFIG_VALUE_START_CLKHS_ON    (1U)
#define GP21_CONFIG_VALUE_START_CLKHS_480US (2U)
#define GP21_CONFIG_VALUE_START_CLKHS_1MS   (3U)
#define GP21_CONFIG_VALUE_START_CLKHS_2MS   (4U)
#define GP21_CONFIG_VALUE_START_CLKHS_5MS   (5U)
#define GP21_CONFIG_VALUE_ANZ_PORT_MASK     (1U<<17)
#define GP21_CONFIG_VALUE_ANZ_PORT_2        (0U<<17)
#define GP21_CONFIG_VALUE_ANZ_PORT_4        (1U<<17)
#define GP21_CONFIG_VALUE_TCYCLE_MASK       (1U<<16)
#define GP21_CONFIG_VALUE_TCYCLE_128US      (0U<<16)
#define GP21_CONFIG_VALUE_TCYCLE_512US      (1U<<16)
#define GP21_CONFIG_VALUE_ANZ_FAKE_MASK     (1U<<15)
#define GP21_CONFIG_VALUE_ANZ_FAKE_2        (0U<<15)
#define GP21_CONFIG_VALUE_ANZ_FAKE_7        (1U<<15)
#define GP21_CONFIG_VALUE_SEL_ECLK_TMP_MASK (1U<<14)
#define GP21_CONFIG_VALUE_SEL_ECLK_TMP_L    (0U<<14)
#define GP21_CONFIG_VALUE_SEL_ECLK_TMP_H    (1U<<14)
#define GP21_CONFIG_VALUE_CALIBRATE_MASK    (1U<<13)
#define GP21_CONFIG_VALUE_CALIBRATE_OFF     (0U<<13)
#define GP21_CONFIG_VALUE_CALIBRATE_ON      (1U<<13)
#define GP21_CONFIG_VALUE_NO_CAL_AUTO_MASK  (1U<<12)
#define GP21_CONFIG_VALUE_CAL_AUTO_ON       (0U<<12)
#define GP21_CONFIG_VALUE_CAL_AUTO_OFF      (1U<<12)
#define GP21_CONFIG_VALUE_MRANGE_MASK       (1U<<11)
#define GP21_CONFIG_VALUE_MRANGE_1          (0U<<11)
#define GP21_CONFIG_VALUE_MRANGE_2          (1U<<11)
#define GP21_CONFIG_VALUE_STOP2_EDGE_MASK   (1U<<10)
#define GP21_CONFIG_VALUE_STOP2_EDGE_RISE   (0U<<10)
#define GP21_CONFIG_VALUE_STOP2_EDGE_FALL   (1U<<10)
#define GP21_CONFIG_VALUE_STOP1_EDGE_MASK   (1U<<9)
#define GP21_CONFIG_VALUE_STOP1_EDGE_RISE   (0U<<9)
#define GP21_CONFIG_VALUE_STOP1_EDGE_FALL   (1U<<9)
#define GP21_CONFIG_VALUE_START_EDGE_MASK   (1U<<8)
#define GP21_CONFIG_VALUE_START_EDGE_RISE   (0U<<8)
#define GP21_CONFIG_VALUE_START_EDGE_FALL   (1U<<8)
#define GP21_CONFIG_VALUE_DEF_REG0          (0x00000000U)
#define GP21_CONFIG_VALUE_ID0(v)            (((v)>>0)&0xFFU)

/*
    config register1 :
    HIT2                 HIT1              EN_FAST_INIT
    HITIN2               HITIN1            CURR32K
    SEL_START_FIRE       SEL_TSTO2         SEL_TSTO1
    ID1
*/
#define GP21_CONFIG_VALUE_HIT2_MASK         (15U<<28)
#define GP21_CONFIG_VALUE_HIT2_MR1_CH_START (0U<<28)
#define GP21_CONFIG_VALUE_HIT2_MR1_CH_SPCH1_1 (1U<<28)
#define GP21_CONFIG_VALUE_HIT2_MR1_CH_SPCH1_2 (2U<<28)
#define GP21_CONFIG_VALUE_HIT2_MR1_CH_SPCH1_3 (3U<<28)
#define GP21_CONFIG_VALUE_HIT2_MR1_CH_SPCH1_4 (4U<<28)
#define GP21_CONFIG_VALUE_HIT2_MR1_NO_ACTION (5U<<28)
#define GP21_CONFIG_VALUE_HIT2_MR1_CH_SPCH1_CAL1 (6U<<28)
#define GP21_CONFIG_VALUE_HIT2_MR1_CH_SPCH1_CAL2 (7U<<28)
#define GP21_CONFIG_VALUE_HIT2_MR1_CH_SPCH2_1 (9U<<28)
#define GP21_CONFIG_VALUE_HIT2_MR1_CH_SPCH2_2 (10U<<28)
#define GP21_CONFIG_VALUE_HIT2_MR1_CH_SPCH2_3 (11U<<28)
#define GP21_CONFIG_VALUE_HIT2_MR1_CH_SPCH2_4 (12U<<28)
#define GP21_CONFIG_VALUE_HIT2_MR2_CH_SPCH1_1 (2U<<28)
#define GP21_CONFIG_VALUE_HIT2_MR2_CH_SPCH1_2 (3U<<28)
#define GP21_CONFIG_VALUE_HIT2_MR2_CH_SPCH1_3 (4U<<28)
#define GP21_CONFIG_VALUE_HIT1_MASK         (15U<<24)
#define GP21_CONFIG_VALUE_HIT1_MR1_CH_START (0U<<24)
#define GP21_CONFIG_VALUE_HIT1_MR1_CH_SPCH1_1 (1U<<24)
#define GP21_CONFIG_VALUE_HIT1_MR1_CH_SPCH1_2 (2U<<24)
#define GP21_CONFIG_VALUE_HIT1_MR1_CH_SPCH1_3 (3U<<24)
#define GP21_CONFIG_VALUE_HIT1_MR1_CH_SPCH1_4 (4U<<24)
#define GP21_CONFIG_VALUE_HIT1_MR1_NO_ACTION (5U<<24)
#define GP21_CONFIG_VALUE_HIT1_MR1_CH_SPCH1_CAL1 (6U<<24)
#define GP21_CONFIG_VALUE_HIT1_MR1_CH_SPCH1_CAL2 (7U<<24)
#define GP21_CONFIG_VALUE_HIT1_MR1_CH_SPCH2_1 (9U<<24)
#define GP21_CONFIG_VALUE_HIT1_MR1_CH_SPCH2_2 (10U<<24)
#define GP21_CONFIG_VALUE_HIT1_MR1_CH_SPCH2_3 (11U<<24)
#define GP21_CONFIG_VALUE_HIT1_MR1_CH_SPCH2_4 (12U<<24)
#define GP21_CONFIG_VALUE_HIT1_MR2_CH_START (1U<<24)
#define GP21_CONFIG_VALUE_FAST_INIT_MASK    (1U<<23)
#define GP21_CONFIG_VALUE_FAST_INIT_OFF     (0U<<23)
#define GP21_CONFIG_VALUE_FAST_INIT_ON      (1U<<23)
#define GP21_CONFIG_VALUE_HITIN_SP2_MASK    (7U<<19)
#define GP21_CONFIG_VALUE_HITIN_SP2_OFF     (0U<<19)
#define GP21_CONFIG_VALUE_HITIN_SP2_1       (1U<<19)
#define GP21_CONFIG_VALUE_HITIN_SP2_2       (2U<<19)
#define GP21_CONFIG_VALUE_HITIN_SP2_3       (3U<<19)
#define GP21_CONFIG_VALUE_HITIN_SP2_4       (4U<<19)
#define GP21_CONFIG_VALUE_HITIN_SP1_MASK    (7U<<16)
#define GP21_CONFIG_VALUE_HITIN_SP1_OFF     (0U<<16)
#define GP21_CONFIG_VALUE_HITIN_SP1_1       (1U<<16)
#define GP21_CONFIG_VALUE_HITIN_SP1_2       (2U<<16)
#define GP21_CONFIG_VALUE_HITIN_SP1_3       (3U<<16)
#define GP21_CONFIG_VALUE_HITIN_SP1_4       (4U<<16)
#define GP21_CONFIG_VALUE_CURR32_MASK       (1U<<15)
#define GP21_CONFIG_VALUE_CURR32_L          (0U<<15)
#define GP21_CONFIG_VALUE_CURR32_H          (1U<<15)
#define GP21_CONFIG_VALUE_SEL_FIRE_MASK     (1U<<14)
#define GP21_CONFIG_VALUE_SEL_FIRE_OUT      (0U<<14)
#define GP21_CONFIG_VALUE_SEL_FIRE_INTER    (1U<<14)
#define GP21_CONFIG_VALUE_ENSTART_FN_MASK   (7U<<11)
#define GP21_CONFIG_VALUE_ENSTART_FN_IN     (0U<<11)
#define GP21_CONFIG_VALUE_ENSTART_FN_START  (1U<<11)
#define GP21_CONFIG_VALUE_ENSTART_FN_SP1    (2U<<11)
#define GP21_CONFIG_VALUE_ENSTART_FN_SP2    (3U<<11)
#define GP21_CONFIG_VALUE_ENSTART_FN_TEMP_SP (4U<<11)
#define GP21_CONFIG_VALUE_ENSTART_FN_TOF_ST (5U<<11)
#define GP21_CONFIG_VALUE_ENSTART_FN_4KHZ   (7U<<11)
#define GP21_CONFIG_VALUE_FIREIN_FN_MASK    (7U<<8)
#define GP21_CONFIG_VALUE_FIREIN_FN_IN      (0U<<8)
#define GP21_CONFIG_VALUE_FIREIN_FN_START   (1U<<8)
#define GP21_CONFIG_VALUE_FIREIN_FN_SP1     (2U<<8)
#define GP21_CONFIG_VALUE_FIREIN_FN_SP2     (3U<<8)
#define GP21_CONFIG_VALUE_FIREIN_FN_TEMP_SP (4U<<8)
#define GP21_CONFIG_VALUE_FIREIN_FN_ENSP    (5U<<8)
#define GP21_CONFIG_VALUE_FIREIN_FN_COMP    (6U<<8)
#define GP21_CONFIG_VALUE_FIREIN_FN_32KHZ   (7U<<8)
#define GP21_CONFIG_VALUE_DEF_REG1          (0x00400000U)
#define GP21_CONFIG_VALUE_ID1(v)            (((v)>>8)&0xFFU)

/*
    config register2 :
    EN_INT               RFEDGE1           RFEDGE2
    DELVAL1              ID2
*/
#define GP21_CONFIG_VALUE_TIMEOUT_INT_MASK  (1U<<31)
#define GP21_CONFIG_VALUE_TIMEOUT_INT_ON    (1U<<31)
#define GP21_CONFIG_VALUE_TIMEOUT_INT_OFF   (0U<<31)
#define GP21_CONFIG_VALUE_HITEND_INT_MASK   (1U<<30)
#define GP21_CONFIG_VALUE_HITEND_INT_ON     (1U<<30)
#define GP21_CONFIG_VALUE_HITEND_INT_OFF    (0U<<30)
#define GP21_CONFIG_VALUE_ALU_INT_MASK      (1U<<29)
#define GP21_CONFIG_VALUE_ALU_INT_ON        (1U<<29)
#define GP21_CONFIG_VALUE_ALU_INT_OFF       (0U<<29)
#define GP21_CONFIG_VALUE_CH2_EDGE_MASK     (1U<<28)
#define GP21_CONFIG_VALUE_CH2_EDGE_BOTH     (1U<<28)
#define GP21_CONFIG_VALUE_CH2_EDGE_ONE      (0U<<28)
#define GP21_CONFIG_VALUE_CH1_EDGE_MASK     (1U<<27)
#define GP21_CONFIG_VALUE_CH1_EDGE_BOTH     (1U<<27)
#define GP21_CONFIG_VALUE_CH1_EDGE_ONE      (0U<<27)
#define GP21_CONFIG_VALUE_DELVAL1_MASK      (0x07FFFFU<<8)
#define GP21_CONFIG_VALUE_DELVAL1(v)        ((v)<<(7-(GP21_CONFIG_VALUE_DIV_CLKHS_1>>20)+8))
#define GP21_CONFIG_VALUE_DEF_REG2          (0x00000000U)
#define GP21_CONFIG_VALUE_ID2(v)            (((v)>>16)&0xFFU)

/*
    config register3 :
    EN_ERR_VAL           SEL_TIMO_MB2      DELVAL2
    ID3
*/
#define GP21_CONFIG_VALUE_EN_ERR_VAL_MASK   (1U<<29)
#define GP21_CONFIG_VALUE_EN_ERR_VAL_OFF    (0U<<29)
#define GP21_CONFIG_VALUE_EN_ERR_VAL_ON     (1U<<29)
#define GP21_CONFIG_VALUE_SEL_TIMO_MB2_MASK (3U<<27)
#define GP21_CONFIG_VALUE_SEL_TIMO_MB2_64   (0U<<27)
#define GP21_CONFIG_VALUE_SEL_TIMO_MB2_256  (1U<<27)
#define GP21_CONFIG_VALUE_SEL_TIMO_MB2_1024 (2U<<27)
#define GP21_CONFIG_VALUE_SEL_TIMO_MB2_4096 (3U<<27)
#define GP21_CONFIG_VALUE_DELVAL2_MASK      (0x07FFFFU<<8)
#define GP21_CONFIG_VALUE_DELVAL2(v)        ((GP21_CONFIG_VALUE_DELVAL1(v))+ \
        (4<<(5+(GP21_CONFIG_VALUE_DIV_CLKHS_1>>20)+8)))
#define GP21_CONFIG_VALUE_DEF_REG3          (0x00000000U)
#define GP21_CONFIG_VALUE_ID3(v)            (((v)>>24)&0xFFU)

/*
    config register4 :
    DELVAL3              ID4
*/
#define GP21_CONFIG_VALUE_DELVAL3_MASK      (0x07FFFFU<<8)
#define GP21_CONFIG_VALUE_DELVAL3(v)        ((GP21_CONFIG_VALUE_DELVAL2(v))+ \
        (4<<(5+(GP21_CONFIG_VALUE_DIV_CLKHS_1>>20)+8)))
#define GP21_CONFIG_VALUE_DEF_REG4          (0x20000000U)
#define GP21_CONFIG_VALUE_ID4(v)            (((v)>>0)&0xFFU)

/*
    config register5 :
    CON_FIRE             EN_STARTNOISE     DIS_PHASESHIFT
    REPEAT_FIRE          PHASE_FIRE        ID5
*/
#define GP21_CONFIG_VALUE_CONF_FIRE_MASK    (7U<<29)
#define GP21_CONFIG_VALUE_CONF_FIRE_BOTH    (1U<<31)
#define GP21_CONFIG_VALUE_CONF_FIRE_EN_UP   (1U<<30)
#define GP21_CONFIG_VALUE_CONF_FIRE_EN_DOWN (1U<<29)
#define GP21_CONFIG_VALUE_STARTNOISE_MASK   (1U<<28)
#define GP21_CONFIG_VALUE_STARTNOISE_ON     (1U<<28)
#define GP21_CONFIG_VALUE_STARTNOISE_OFF    (0U<<28)
#define GP21_CONFIG_VALUE_DIS_PH_NOISE_MASK (1U<<27)
#define GP21_CONFIG_VALUE_PH_NOISE_ON       (0U<<27)
#define GP21_CONFIG_VALUE_PH_NOISE_OFF      (1U<<27)
#define GP21_CONFIG_VALUE_REPEAT_FIRE_MASK  (7U<<24)
#define GP21_CONFIG_VALUE_REPEAT_FIRE_TIMES(v) (((v)&0x07U)<<24)
#define GP21_CONFIG_VALUE_PH_FIRE_MASK      (0xFFFFU<<8)
#define GP21_CONFIG_VALUE_PH_FIRE_INV(ch)   (1U<<(8+(ch)))
#define GP21_CONFIG_VALUE_DEF_REG5          (0x00000000U)
#define GP21_CONFIG_VALUE_ID5(v)            (((v)>>8)&0xFFU)

/*
    config register6 :
    EN_ANALOG            NEG_STOP_TEMP     TW2
    EN_INT               START_CLKHS       CYCLE_TEMP
    CYCLE_TOF            HZ60              FIREO_DEF
    QUAD_RES             DOUBLE_RES        TEMP_PORTDIR
    ANZ_FIRE             ID6
*/
#define GP21_CONFIG_VALUE_EN_ANALOG_MASK    (1U<<31)
#define GP21_CONFIG_VALUE_ANALOG_ON         (1U<<31)
#define GP21_CONFIG_VALUE_ANALOG_OFF        (0U<<31)
#define GP21_CONFIG_VALUE_NEG_STOP_TEMP_MASK (1U<<30)
#define GP21_CONFIG_VALUE_NEG_STOP_TEMP_EX  (0U<<30)
#define GP21_CONFIG_VALUE_NEG_STOP_TEMP_INTER (1U<<30)
#define GP21_CONFIG_VALUE_COMP_OFFSET_MASK  (15U<<25)
#define GP21_CONFIG_VALUE_COMP_OFFSET_0MV   (0U<<25)
#define GP21_CONFIG_VALUE_COMP_OFFSET_1MV   (1U<<25)
#define GP21_CONFIG_VALUE_COMP_OFFSET_2MV   (2U<<25)
#define GP21_CONFIG_VALUE_COMP_OFFSET_3MV   (3U<<25)
#define GP21_CONFIG_VALUE_COMP_OFFSET_4MV   (4U<<25)
#define GP21_CONFIG_VALUE_COMP_OFFSET_5MV   (5U<<25)
#define GP21_CONFIG_VALUE_COMP_OFFSET_6MV   (6U<<25)
#define GP21_CONFIG_VALUE_COMP_OFFSET_7MV   (7U<<25)
#define GP21_CONFIG_VALUE_COMP_OFFSET_M1MV  (15U<<25)
#define GP21_CONFIG_VALUE_COMP_OFFSET_M2MV  (14U<<25)
#define GP21_CONFIG_VALUE_COMP_OFFSET_M3MV  (13U<<25)
#define GP21_CONFIG_VALUE_COMP_OFFSET_M4MV  (12U<<25)
#define GP21_CONFIG_VALUE_COMP_OFFSET_M5MV  (11U<<25)
#define GP21_CONFIG_VALUE_COMP_OFFSET_M6MV  (10U<<25)
#define GP21_CONFIG_VALUE_COMP_OFFSET_M7MV  (9U<<25)
#define GP21_CONFIG_VALUE_COMP_OFFSET_M8MV  (8U<<25)
#define GP21_CONFIG_VALUE_RC_TIME_MASK      (3U<<22)
#define GP21_CONFIG_VALUE_RC_TIME_90US      (0U<<22)
#define GP21_CONFIG_VALUE_RC_TIME_120US     (1U<<22)
#define GP21_CONFIG_VALUE_RC_TIME_150US     (2U<<22)
#define GP21_CONFIG_VALUE_RC_TIME_300US     (3U<<22)
#define GP21_CONFIG_VALUE_EEPROM_INT_MASK   (1U<<21)
#define GP21_CONFIG_VALUE_EEPROM_INT_ON     (1U<<21)
#define GP21_CONFIG_VALUE_EEPROM_INT_OFF    (0U<<21)
#define GP21_CONFIG_VALUE_START_CLKHS_H(v)  ((((v)>>2)&0x01U)<<20)
#define GP21_CONFIG_VALUE_CYCLE_TEMP_MASK   (3U<<18)
#define GP21_CONFIG_VALUE_CYCLE_TEMP_1      (0U<<18)
#define GP21_CONFIG_VALUE_CYCLE_TEMP_1_5    (1U<<18)
#define GP21_CONFIG_VALUE_CYCLE_TEMP_2      (2U<<18)
#define GP21_CONFIG_VALUE_CYCLE_TEMP_2_5    (3U<<18)
#define GP21_CONFIG_VALUE_CYCLE_TOF_MASK    (3U<<16)
#define GP21_CONFIG_VALUE_CYCLE_TOF_1       (0U<<16)
#define GP21_CONFIG_VALUE_CYCLE_TOF_1_5     (1U<<16)
#define GP21_CONFIG_VALUE_CYCLE_TOF_2       (2U<<16)
#define GP21_CONFIG_VALUE_CYCLE_TOF_2_5     (3U<<16)
#define GP21_CONFIG_VALUE_HZ60_MASK         (1U<<15)
#define GP21_CONFIG_VALUE_HZ60              (1U<<15)
#define GP21_CONFIG_VALUE_HZ50              (0U<<15)
#define GP21_CONFIG_VALUE_FIREO_DEF_MASK    (1U<<14)
#define GP21_CONFIG_VALUE_FIREO_HZ          (0U<<14)
#define GP21_CONFIG_VALUE_FIREO_L           (1U<<14)
#define GP21_CONFIG_VALUE_QUAD_RES_MASK     (1U<<13)
#define GP21_CONFIG_VALUE_QUAD_RES_ON       (1U<<13)
#define GP21_CONFIG_VALUE_QUAD_RES_OFF      (0U<<13)
#define GP21_CONFIG_VALUE_DOUBLE_RES_MASK   (1U<<12)
#define GP21_CONFIG_VALUE_DOUBLE_RES_ON     (1U<<12)
#define GP21_CONFIG_VALUE_DOUBLE_RES_OFF    (0U<<12)
#define GP21_CONFIG_VALUE_TEMP_PORTDIR_MASK (1U<<11)
#define GP21_CONFIG_VALUE_TEMP_PORT_1_4     (0U<<11)
#define GP21_CONFIG_VALUE_TEMP_PORT_4_1     (1U<<11)
#define GP21_CONFIG_VALUE_ANZ_FIRE_H(v)     ((((v)>>4)&0x07U)<<8)
#define GP21_CONFIG_VALUE_DEF_REG6          (0x00000000U)
#define GP21_CONFIG_VALUE_ID6(v)            (((v)>>16)&0xFFU)

typedef struct {
  __IO uint32_t *INTN;
  __IO uint32_t *SSN;
  SPI_HandleTypeDef *SPI;
  __IO uint32_t *RSTN;
  __IO uint32_t *EN_STOP2;
  __IO uint32_t *EN_STOP1;
  __IO uint32_t *START;
  __IO uint32_t *EN_START;
} TDC;

void TDC_Initialize(TDC *tdc);
void TDC_SendCommand(TDC *tdc, uint8_t command);
void TDC_WriteConfigurationRegister(TDC *tdc, uint8_t address, uint32_t value);
bool TDC_TestCommunication(TDC *tdc, uint8_t expected);
void TDC_WaitForInterrupt(TDC *tdc);
bool TDC_CheckInterruptStatus(TDC *tdc);
uint16_t TDC_ReadStatusRegister(TDC *tdc);
uint32_t TDC_ReadResultRegister(TDC *tdc, uint8_t address);

#endif
